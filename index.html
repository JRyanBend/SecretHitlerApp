<!doctype html>
<html>
    <head>
        <title>Secret Hitler!</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>

            /* Base */
            * { margin: 0; padding: 0; box-sizing: border-box; }

            body { 
                font: 16px Helvetica, Arial;
                overflow: hidden; 
            }

            h1,h2,h3,h4,h5 {
                margin-bottom: 0.5em;
            }

            .text--small {
                font-size: 0.7em;
            }

            .text {
                font-size: 1em;
            }

            .text--large {
                font-size: 1.3em;
            }

            .text--larger {
                font-size: 1.7em;
            }

            .text--bold {
                font-weight: 700;
            }

            .title {
                font-size: 2em;
            }

            .title--sub {
              font-size: 1.3em;
            }

            .button {
                padding: 10px;
                background-color: #fff;
                border: 1px solid #333;
                color: #333;
                border-radius: 3px;
                margin: 1em;
                cursor: pointer;
                font-weight: bold;
                text-transform: uppercase;
                transition: background-color 0.5s;
            }

            .button:hover {
                background-color: #ccc;
            }

            .form {

            }

            .form__label {

            }

            .form__input {
                border: none;
                padding: 0.4em;
                font-size: 1em;
                border: 2px solid #333;
                border-radius: 3px;
            }
            .error {
                display: none;
                color: red;
                background-color: #fff;
                border-radius: 3px;
                border: 1px solid #333;
            }


            /* Header */
            .header {
                min-height: 2.5em;
                background-color: #333;
            }

            .header .username {
                display: inline-block;
                color: #fff;
                font-weight: bold;
                padding: 0.6em;
                cursor: pointer;
            }

            .header .menu {
                display: inline-block;
                color: #fff;
                font-weight: bold;
                padding: 0.6em;
                cursor: pointer;
                position: absolute;
                right: 0;
            }


            /* Chat */
            .chat { 
                background: #000; 
                padding: 3px;
                position: fixed; 
                bottom: 0; 
                width: 100%; 
             }

            .chat input { 
                border: 0; 
                padding: 10px; 
                width: 90%; 
                margin-right: .5%; 
            }

            .chat button { 
                width: 9%; 
                background: rgb(130, 224, 255); 
                border: none; 
                padding: 10 px; 
            }

            #messages { 
                list-style-type: none; 
                margin: 0; 
                padding: 0; 
            }

            #messages li { 
                padding: 5px 10px; 
            }

            #messages li:nth-child(odd) { 
                background: #eee; 
            }

      
            /* Splash Screen */
            .shroud {
                position: fixed;
                height: 100%;
                width: 100%;
                background-color: red;
                color: #fff;
                z-index: 2;
                overflow-y: auto;
                overflow-x: hidden;
            }
      
            .intro {
                min-height: 100px;
                max-height: 1100px;
                max-width: 500px;
                margin: auto;
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 20px;
                text-align: center;
            }

            .intro__form {
                background-color: darkred;
                padding: 20px;
                border-radius: 2px;
                border: 1px solid #333;
                margin-bottom: 20px;
            }

            .logo {
                width: 100%;
                -webkit-animation: mover 2s infinite;
                animation: logo-float 2s infinite ease-in-out;
            }

            @-webkit-keyframes logo-float {
                0% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
                100% { transform: translateY(0); }
            }

            @keyframes logo-float {
                0% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
                100% { transform: translateY(0); }
            }
  
            .button--unready,
            .button--unready:hover {
                border-color: darkgreen;
                background-color: green;
                color: #fff;
            }

            .intro .button--ready,
            .intro .button--ready:hover {
                border-color: forestgreen;
                background-color: darkgreen;
                color: #fff;
            }

            .button--start,
            .button--start:hover {
                border-color: #333;
                background-color: #555;
                color: #fff;
                display: none;
            }

            .user-ready {
                display: none;
            }

            .form--nickname .form__label {
                display: block;
                margin-bottom: 0.5em;
            }

            .form--nickname .form__input {
                display: inline-block;
                width: 75%;
                margin: 0 1em 1em 1em;
                border: 3px dashed #333;
                font-size: 2em;
                text-align: center;
            }

            .form--nickname .button {
                display: inline-block;
                width: 75%;
                margin: 0 1em 1em 1em;
            }

            /* Sidebar */      
            .sidebar {
                position: fixed;
                right: -300px;
                height: 100%;
                width: 300px;
                background-color:#333;
                color: #fff;
                z-index: 1;
                transition: all 0.5s;
            }

            .sidebar .sidebar__close {
                cursor: pointer;
                background-color: #555;
                padding-bottom: 10px;
                margin-bottom: 0;
            }

            .sidebar--show {
                right: 0;
            } 

            .sidebar .user_list ul li {
                border: none;
                border-radius: none;
                transition: color 0.3s;
            }

            .sidebar .user_list ul li:hover {
                color: #ccc;
            }
      
            .sidebar h3 {
                padding: 10px 10px 0px 10px;
            }
            

            /* Userlist module */
            .user_list ul {
                list-style-type: none;
                margin: 0;
                padding: 10px;
            }

            .user_list ul li {
                padding: 10px 5px;
                font-size: 16px;
                border: 1px solid #fff;
                margin: 10px 5px;
                border-radius: 50px;
                background-color: #333;
                font-weight: bold;
            }

            .user_list ul li .ready-bubble {
                height: 10px;
                width: 10px;
                background-color: red;
                display: inline-block;
                border-radius: 100%;
                transition: all 0.5s;
                margin-right: 10px;
            }

            .user_list ul li .ready-bubble.ready-bubble--ready {
                height: 12px;
                width: 12px;
                background-color: green;
            }

            

            /* Vote Stuff */
            .votes {
                border: 1px solid #ddd;
                padding: 10px;
                background-color: #eee;
            }
      
            .votes button {
                width: 100%;
                max-width: 5em;
                padding: 5px;
                margin: 5px;
                border: 1px solid #ccc;
                border-radius: 3px;
                background-color: #ddd;
            }
    
        </style>
    </head>
    <body>
        <div class="shroud">
            <div class="intro">
                <img class="logo" src="img/SecretHitlerLogo.png">
                <div class="intro__form">
                    <form id="nickname" class="form form--nickname">
                        <label class="form__label">Please enter a nickname:</label>
                        <input id="nick" autocomplete="off" class="form__input" />
                        <p class="error" id="name_error">That name is already taken, please try another one</p>
                        <button class="button button--form">Let 'er Rip!</button>
                    </form>
                    <div class="user-ready" id="user-ready">
                        <h3 class="title title--sub">Waiting for users to start...</h3>
                        <div id="user_list" class="user_list">
                            <p>You're the only one here!</p>    
                        </div>
                        <button id="user-confirmed" class="button button--unready">Ready!</button>
                        <button id="start-game" class="button button--start">Start Game!</button>
                    </div>
                </div>
            </div>
        </div>
        <aside class="sidebar">
            <h3 id="sidebar-close" class="sidebar__close"> < Close</h3>
            <hr />
            <h3>Currently Online</h3>
            <div id="user_list2" class="user_list"></div>
            <button id="call_vote">Call Vote</div>
        </aside>

        <header class="header">
            <div id="username" class="username text-large"></div>
            <div class="menu" id="menu">Menu</div>
        </header>
        <ul id="messages" class="messages"></ul>
        <form id="send_msg" action="" class="chat">
            <input id="m" autocomplete="off" /><button>Send</button>
        </form>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

        <script>
        $(function() {
            var socket = io();
            var currentUser;

            //////////////////////////////////////////////////////////////
            // Utility Functions
            //////////////////////////////////////////////////////////////

            // Toggle menu on click
            $("#menu, #sidebar-close").on("click", function() {
                $(".sidebar").toggleClass("sidebar--show");
            });



            // Display lightbox
            function lightbox(args) {
              
            }

            //Cookie Helpers
            function createCookie(name,value,days) {
                if (days) {
                    var date = new Date();
                    date.setTime(date.getTime()+(days*24*60*60*1000));
                    var expires = "; expires="+date.toGMTString();
                }
                else var expires = "";
                document.cookie = name+"="+value+expires+"; path=/";
            }

            function readCookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');
                for(var i=0;i < ca.length;i++) {
                    var c = ca[i];
                    while (c.charAt(0)==' ') c = c.substring(1,c.length);
                    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
                }
                return null;
            }

            function eraseCookie(name) {
                createCookie(name,"",-1);
            }


            //////////////////////////////////////////////////////////////
            // User tracking
            //////////////////////////////////////////////////////////////

            // When a user connects/disconnects, update the 'Currently Online' sidebar
            socket.on('update users', function(people) {
                console.log(people);
                if(people.length) {
                    var userList = document.createElement('ul');
                    
                    for(var i = 0;i < people.length;i++) {
                        // TODO: fix the ready bubble so it animates properly
                        // To fix this I'd have to rewrite how the list is updated
                        // It's superflous and would be complicated so not anytime soon
                        var userReady = people[i].ready ? ' ready-bubble--ready' : '';
                        $(userList).append('<li><span class="ready-bubble ' + userReady + '"></span>' + people[i].nick + '</li>');
                    }

                    // TODO: This is super ugly. fix it. Also it doesn't seem to work properly
                    $("#user_list").html('').append(userList);
                    $("#user_list2").html('');
                    $("#user_list").clone().appendTo("#user_list2");
                }
            });


            // When a disconnects, show a debreif screen
            socket.on('disconnecter', function(reason) {
                console.log("Sorry we full!");
                switch (reason) {
                    case "reset":
                        $("body").html('').append("Sorry, the Server just reset, please restart your browser to start the game");
                        break;
                    case "started":
                        $("body").html('').append("Sorry, the game is currently in progress, please try again.");
                        break;
                    case "full":
                        $("body").html('').append("Sorry, the game is currently full, please try again.");
                        break;
                    default:
                        $("body").html('').append("Sorry, the game is currently full or in progress, please try again.");
                        break;
                }
            });

            // Client notices server disconnect, displays correct screen
            socket.on('disconnect', function () {
              $("body").html('').append("Sorry, the Server just reset, please reload your browser to start the game");
            });

            socket.on('check cookie', function(d) {
                var data_array = [];
                var gameId = readCookie('secret-hitler-game');
                var username = readCookie('username');

                if(gameId) {
                    data_array.push(gameId);
                    if(username){
                        data_array.push(username);
                    }
                    socket.emit('cookie success', data_array);                    
                } else {
                    socket.emit('cookie failed');    
                }
            });


            //////////////////////////////////////////////////////////////
            // Initial display logic
            //////////////////////////////////////////////////////////////

            // Collect your nickname and send it to index.js to append to your messages
            // TODO: Better name validation, maybe set currentUser somewhere safer
            $('#nickname').submit(function(){
                if($('#nick').val().length > 0 ) {
                    currentUser = $('#nick').val();
                    socket.emit('nickname', currentUser);
                    return false;
                } else {
                  console.log("Has to be at least one character bra")
                }
            });

            // If nick already exists get them to try again
            socket.on("name error", function(isError) {
                if(isError) {
                    // Tell the user that they need to pick a name that isn't in use
                    $("#name_error").show();
                } else {
                    $("#name_error").hide();
                    $('#nickname').hide();
                    $('#user-ready').show();
                    $("#username").text(currentUser);
                }
            });

            $("#user-confirmed").on("click", function() {
                var userConfirmed = $("#user-confirmed");

                // Toggle the actual button class for visual feedback
                userConfirmed.toggleClass("button--ready");

                if(userConfirmed.text() === "Ready!") {
                    $("#user-confirmed").text("Cancel");
                } else {
                    $("#user-confirmed").text("Ready!")
                }

                // Right now this is simply toggled back and forth in the server code 
                // when clicked. Not sure if this can be done better
                // TODO: Update this to be a bit more logical?
                socket.emit('declare ready', "test");
            });

            // We have enough players to start a game, display the 'Start Game' button
            socket.on('start button', function(msg) {
                $('#start-game').show();
            });

            // We had enough players to display the 'Start Game' button but lost some and now we're below 5, the minimum
            // amount of players to start a game, remove the start game button
            socket.on('remove start', function(msg) {
                $('#start-game').hide();
            });

            // Someone has clicked 'Start Game!' tell the server and send the user who did it
            $('#start-game').click(function(){
                socket.emit('game started', currentUser);
                return false;
            });

            /* The server says someone has started the game, output who and boot to the game screen
             The 'data' attribute stores:
             [0] = The name of the player who started the game, or the name of the returning player, based on [2] (string)
             [1] = The game id (string)
             [2] = Whether the player is rejoining or not (boolean)

             */
            socket.on('start game', function(data) {
                // Set a cookie with the game number so if they disconnect they can rejoin
                createCookie('secret-hitler-game',data[1],1);
                createCookie('username', currentUser);

                console.log(data);
                // The third slot of the array dictates whether it's a rejoin or not
                if(data[2]) {
                    $('.shroud').hide();
                    $("#username").text(data[0]);
                    emitLocal('<span class="text--bold">' + data[0] + '</span> has rejoined the game!');
                } else {
                    $('.shroud').hide();
                    emitLocal('<span class="text--bold">' + data[0] + '</span> has started the game!');
                }
            });


            
            //////////////////////////////////////////////////////////////
            // Game logic
            //////////////////////////////////////////////////////////////

            // Voting functions
            // If vote is true or false send data to server
            function handleVote(vote){
                if(vote) {
                    console.log("Voted Yes")
                    socket.emit('voted', true);
                    return false;
                } else {
                    console.log("Voted No")
                    socket.emit('voted', false);
                    return false;
                }
            }


            // Emit a message locally
            function emitLocal(msg){
                $('#messages').append($('<li>').html(msg));
            }


            // Sends the message to the server to distribute to all members
      	    $('#send_msg').submit(function(){
                socket.emit('chat message', $('#m') .val());
  	            $('#m').val('');
  	            return false;
      	    });


            // When a message is received, display it
      	    socket.on('chat message', function(msg) {
                $('#messages').append($('<li>').html(msg));
      	    });


            // Call a vote
            $('#call_vote').click(function(){
                socket.emit('call vote', "test");
                return false;
            });


            //Vote call successful, display vote ui
            socket.on('vote called', function(msg) {
                // Disable vote button for all
                $('#call_vote').attr("disabled");

                $('#messages').append($('<li>').html('<div class="votes"><h4><span>{{Nickname}}</span> has nominated <span>{{other name}}</span> for chancellor</h4><button id="vote_yes">JA!</button><button id="vote_no">NEIN!</button></div>'));

                 // Handle a vote
                $(document).on("click","#vote_yes", function() {
                    console.log("Voted Yes")
                    socket.emit('voted', true);
                    return false;
                });
                $(document).on("click","#vote_no", function() {
                    console.log("Voted no")
                    socket.emit('voted', false);
                    return false;
                });
            });


            //Vote complete, display vote completion ui
            socket.on('vote complete', function(result) {

                var results = result ? "Ja" : "Nein";

                // Replace with full screen ui, just hide and show as neccessary
                $('#messages').append($('<li>').html('<div class="votes"><h4>The ' + results + 's have it!</h4></div>'));
            });
        });
        </script>
    </body>
</html>
